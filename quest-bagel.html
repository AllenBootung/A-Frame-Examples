<!DOCTYPE html>
<html>

<head>
	<title>Hello, WebVR! - A-Frame</title>
	<meta name="description" content="Hello, WebVR! - A-Frame">
	<script src="js/aframe-master-v1.3.0.min.js"></script>
  <script src="js/aframe-environment-component.js"></script>
  <script src="js/controller-listener.js"></script>
  <script src="js/player-move.js"></script>
  <script src="js/raycaster-extras.js"></script>
</head>

<body>

<script>
AFRAME.registerComponent('text-display', {
	
	tick: function()
	{
		//let dataLeft  = document.querySelector("#left-controller-entity").components["controller-listener"];
		//let dataRight = document.querySelector("#right-controller-entity").components["controller-listener"];

	},
	
});

AFRAME.registerComponent('gamepad-model', {
	schema:
    {
        controllerListenerId: {type: 'string', default: "#controller-data"},
        playerMoveId:         {type: 'string', default: "#player"},
    },


	init: function()
	{
			this.controllerData     = document.querySelector(this.data.controllerListenerId).components["controller-listener"];
			this.playerMoveControls = document.querySelector(this.data.playerMoveId).components["player-move"];
			
			// enabled: gamepad responds to controller input, player movement disabled
			this.enabled = false;

		  // TODO: larger containing box for interact/grab?

			let centerBoxWidth = 0.75; 
			let centerBoxHeight = 0.50;
			let stickRadius = 0.070; // half this for knob radius, and also maximum offset
			let buttonRadius = 0.040;

	    this.centerBox = document.createElement("a-entity");
	    this.centerBox.setAttribute("geometry", 
	     { primitive: "box", width: centerBoxWidth, height: centerBoxHeight, depth: 0.05 } );
	    this.centerBox.setAttribute("material", "color", "#222222");
	    this.centerBox.setAttribute("raycaster-target", "canGrab: true;");
	    this.el.appendChild(this.centerBox);

	    this.leftSide = document.createElement("a-entity");
	    this.leftSide.setAttribute("geometry", 
	     { primitive: "cylinder", radius: centerBoxHeight/2, height: 0.05, thetaStart: 180, thetaLength: 180 } );
	    this.leftSide.setAttribute("material", "color", "#FF69B4");
	    this.leftSide.setAttribute("position", {x: -centerBoxWidth/2, y: 0, z: 0});
	    this.leftSide.setAttribute("rotation", "90 0 0");
	    this.centerBox.appendChild(this.leftSide);

	    this.leftStickBase = document.createElement("a-entity");
	    this.leftStickBase.setAttribute("geometry", 
	     { primitive: "cylinder", radius: stickRadius, height: 0.05 } );
	    this.leftStickBase.setAttribute("material", 
	      { src: "#circleBlank", color: "#CCCCCC" } );
	    this.leftStickBase.setAttribute("position", {x: -0.17, y: 0.005, z: 0});
	    this.leftSide.appendChild( this.leftStickBase );

	    this.leftStickKnob = document.createElement("a-entity");
	    this.leftStickKnob.setAttribute("geometry", 
	     { primitive: "cylinder", radius: stickRadius/2, height: 0.05 } );
	    this.leftStickKnob.setAttribute("material", "color", "#444444");
	    this.leftStickKnob.setAttribute("position", {x: 0, y: 0.01, z: 0});
	    this.leftStickBase.appendChild( this.leftStickKnob );

	    this.leftButtonY = document.createElement("a-entity");
	    this.leftButtonY.setAttribute("geometry", 
	     { primitive: "cylinder", radius: buttonRadius, height: 0.05 } );
	    this.leftButtonY.setAttribute("material", 
	    	{ src: "#circleY", color: "white"} );
	    this.leftButtonY.setAttribute("position", {x: -0.05, y: 0.005, z: -0.06});
	    this.leftButtonY.setAttribute("rotation", "0 90 0");
	    this.leftSide.appendChild( this.leftButtonY );

	    this.leftButtonX = document.createElement("a-entity");
	    this.leftButtonX.setAttribute("geometry", 
	     { primitive: "cylinder", radius: buttonRadius, height: 0.05 } );
	    this.leftButtonX.setAttribute("material", 
	    	{ src: "#circleX", color: "white"} );
	    this.leftButtonX.setAttribute("position", {x: -0.05, y: 0.005, z:  0.06});
	    this.leftButtonX.setAttribute("rotation", "0 90 0");
	    this.leftSide.appendChild( this.leftButtonX );

	    this.rightSide = document.createElement("a-entity");
	    this.rightSide.setAttribute("geometry", 
	     { primitive: "cylinder", radius: centerBoxHeight/2, height: 0.05, thetaStart: 0, thetaLength: 180 } );
	    this.rightSide.setAttribute("material", "color", "#B469FF");
	    this.rightSide.setAttribute("position", {x: centerBoxWidth/2, y: 0, z: 0});
	    this.rightSide.setAttribute("rotation", "90 0 0");
	    this.centerBox.appendChild(this.rightSide);

	    this.rightStickBase = document.createElement("a-entity");
	    this.rightStickBase.setAttribute("geometry", 
	     { primitive: "cylinder", radius: stickRadius, height: 0.05 } );
	    this.rightStickBase.setAttribute("material", 
	      { src: "#circleBlank", color: "#CCCCCC" } );
	    this.rightStickBase.setAttribute("position", {x: 0.17, y: 0.005, z: 0});
	    this.rightSide.appendChild( this.rightStickBase );

			this.rightStickKnob = document.createElement("a-entity");
	    this.rightStickKnob.setAttribute("geometry", 
	     { primitive: "cylinder", radius: stickRadius/2, height: 0.05 } );
	    this.rightStickKnob.setAttribute("material", "color", "#444444");
	    this.rightStickKnob.setAttribute("position", {x: 0, y: 0.01, z: 0});
	    this.rightStickBase.appendChild( this.rightStickKnob );

	    this.rightButtonB = document.createElement("a-entity");
	    this.rightButtonB.setAttribute("geometry", 
	     { primitive: "cylinder", radius: buttonRadius, height: 0.05 } );
	    this.rightButtonB.setAttribute("material", 
	    	{ src: "#circleB", color: "white"} );
	    this.rightButtonB.setAttribute("position", {x: 0.05, y: 0.005, z: -0.06});
	    this.rightButtonB.setAttribute("rotation", "0 90 0");
	    this.rightSide.appendChild( this.rightButtonB );

	    this.rightButtonA = document.createElement("a-entity");
	    this.rightButtonA.setAttribute("geometry", 
	     { primitive: "cylinder", radius: buttonRadius, height: 0.05 } );
	    this.rightButtonA.setAttribute("material", 
	    	{ src: "#circleA", color: "white"} );
	    this.rightButtonA.setAttribute("position", {x: 0.05, y: 0.005, z:  0.06});
	    this.rightButtonA.setAttribute("rotation", "0 90 0");
	    this.rightSide.appendChild( this.rightButtonA );

	    this.powerLight = document.createElement("a-entity");
 	    this.powerLight.setAttribute("geometry", 
	     { primitive: "sphere", radius: 0.03 } );
	    this.powerLight.setAttribute("material", 
	    	{ color: "#444444", emissive: "#FF0000"} );
	    this.powerLight.setAttribute("position", {x: 0.03, y: 0, z:  0.22});
	    //this.sceneDimmer.setAttribute("rotation", "0 90 0");
	    this.rightSide.appendChild( this.powerLight );


	},

	tick: function()
	{
		  if ( !this.playerMoveControls )
  				this.playerMoveControls = document.querySelector(this.data.playerMoveId).components["player-move"];

		  // clock tick
		 	let deltaTime = 0;
		 	 
		  if ( this.centerBox.components["raycaster-target"].hasFocus && this.controllerData.rightTrigger.pressed )
		  {
		  	  this.playerMoveControls.enabled = !this.playerMoveControls.enabled;
		  	  this.enabled = !this.playerMoveControls.enabled;
		  }

		  if ( !this.enabled )
		  	return;
			
			this.leftStickKnob.setAttribute("position", 
				{x: 0.035 * this.controllerData.leftAxisX, y: 0.01, z: 0.035 * this.controllerData.leftAxisY});

			this.rightStickKnob.setAttribute("position", 
				{x: 0.035 * this.controllerData.rightAxisX, y: 0.01, z: 0.035 * this.controllerData.rightAxisY});

			if ( this.controllerData.buttonA.pressed )
				this.rightButtonA.setAttribute("material", "emissive", "#444444");
			else if ( this.controllerData.buttonA.released )
				this.rightButtonA.setAttribute("material", "emissive", "#000000");

			if ( this.controllerData.buttonB.pressed )
				this.rightButtonB.setAttribute("material", "emissive", "#444444");
			else if ( this.controllerData.buttonB.released )
				this.rightButtonB.setAttribute("material", "emissive", "#000000");

			if ( this.controllerData.buttonX.pressed )
				this.leftButtonX.setAttribute("material", "emissive", "#444444");
			else if ( this.controllerData.buttonX.released )
				this.leftButtonX.setAttribute("material", "emissive", "#000000");

			if ( this.controllerData.buttonY.pressed )
				this.leftButtonY.setAttribute("material", "emissive", "#444444");
			else if ( this.controllerData.buttonY.released )
				this.leftButtonY.setAttribute("material", "emissive", "#000000");

		//let dataLeft  = document.querySelector("#left-controller-entity").components["controller-listener"];
		//let dataRight = document.querySelector("#right-controller-entity").components["controller-listener"];

		// during tick: if grabbed:
		//  button pressed -> highlight, released -> un-highlight
		//  controller stick axisX and axisY -> shift x/z of knob element (max 0.03)
	},
	
});
</script>

<a-scene environment="preset: default;" renderer="antialias: true;">
		
	<a-assets>
		<img id="gradient" src="images/gradient-fade.png" />
		<!-- used by gamepad-model -->
    <img id="circleBlank" src="images/circle-blank.png" />
    <img id="circleA"     src="images/circle-A.png" />
    <img id="circleB"     src="images/circle-B.png" />
    <img id="circleX"     src="images/circle-X.png" />
    <img id="circleY"     src="images/circle-Y.png" />
  </a-assets>

	<a-sky 
		color = "#001337">
	</a-sky>

	<a-entity 
  	  id="player" 
      position="0 0 0" 
      player-move="controllerListenerId: #controller-data;">
        
      <a-camera></a-camera>
    
      <a-entity 
          id="controller-data" 
          controller-listener="leftControllerId:  #left-controller; 
                               rightControllerId: #right-controller;">
      </a-entity>

      <a-entity 
          id="left-controller"
          oculus-touch-controls="hand: left">
      </a-entity>

      <a-entity
          id="right-controller"
          oculus-touch-controls="hand: right"
          raycaster="objects: .raycaster-target, .environmentGround;"
          raycaster-extras="controllerListenerId: #controller-data; 
                            beamImageSrc: #gradient; beamLength: 0.5;">
      </a-entity>

  </a-entity>

	<a-entity
	   gamepad-model="controllerListenerId: #controller-data; playerMoveId: #player;"
	   position="0 1.6 -1">
	</a-entity>

	 <a-torus-knot 
        p="2" q="3" radius="0.5" radius-tubular="0.1"
        position = "-2.5 1.5 -4"
        color="#CC3333"
        raycaster-target>
    </a-torus-knot>
    
    <a-box
        width = "2" height = "1" depth = "1"
        position = "-1 0.5 -3"
        rotation = "0 45 0"  
        color = "#FF8800"
        raycaster-target>
    </a-box>

    <a-sphere
        radius = "1.25"
        position = "0 1.25 -5"
        color = "#DDBB00"
        raycaster-target>
    </a-sphere>
    
    <a-cylinder
        radius = "0.5" height = "1.5"
        position = " 1 0.75 -3"
        color = "#008800" 
        raycaster-target>
    </a-cylinder>

    <a-cone
        radius-bottom = "1" radius-top = "0" height = "2"
        position = "3 1 -4"
        color = "#4444CC"
        raycaster-target>
    </a-cone>
    
    <a-torus 
        radius="0.5" radius-tubular="0.1"
        position = "2 3 -4"
        rotation = "30 -20 0"
        color="#8800FF"
        raycaster-target>
    </a-torus>

    <!-- demo interaction boxes -->

	<a-entity
		id="textArea" 
		position="0 1.5 -1.9"
		geometry="primitive: plane;  width: 3; height: auto"
		material="color: #444444; transparent: true; opacity: 0.80;"
		text="anchor: center; baseline: center; wrapCount: 40;
				transparent: true; opacity: 0.90; color: #8888FF;
				value: [debug messages here]"
		text-display>
	</a-entity>

</a-scene>

</body>
</html>